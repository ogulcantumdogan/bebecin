<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DUS Hazırlık - Bebecin edition ♥</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF69B4',
                        secondary: '#FFB6C1',
                        accent: '#FFC0CB',
                        dark: '#333333',
                        light: '#FFF0F5'
                    },
                    keyframes: {
                        heartbeat: {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(1.1)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    },
                    animation: {
                        heartbeat: 'heartbeat 1.5s ease-in-out infinite',
                        float: 'float 3s ease-in-out infinite',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #FFF0F5;
            min-height: 100vh;
        }
        
        .card {
            perspective: 1000px;
            transition: transform 0.6s;
        }
        
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.8s;
            transform-style: preserve-3d;
        }
        
        .card.flipped .card-inner {
            transform: rotateY(180deg);
        }
        
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 1rem;
            padding: 2rem;
            overflow-y: auto;
        }
        
        .card-front {
            background: linear-gradient(135deg, #FF69B4, #FFB6C1);
            color: white;
        }
        
        .card-back {
            background: white;
            color: #333;
            transform: rotateY(180deg);
            border: 2px solid #FF69B4;
        }
        
        .heart-checkbox {
            clip-path: path('M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z');
            transition: all 0.3s;
        }
        
        .heart-checkbox:checked {
            background-color: #FF69B4;
        }
        
        /* Confetti animation */
        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); }
            100% { transform: translateY(100vh) rotate(720deg); }
        }
        
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            z-index: 1000;
            animation: confetti-fall 5s linear forwards;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 300px;
            z-index: 9999;
            transform: translateX(100%);
            transition: transform 0.4s ease-out;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        /* Custom loader */
        .heart-loader {
            display: inline-block;
            position: relative;
            width: 80px;
            height: 80px;
        }
        
        .heart-loader:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23FF69B4'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E") no-repeat center center;
            animation: heartbeat 1.2s infinite;
        }

        /* Improve progress bar for small percentages */
        .progress-dot {
            width: 10px;
            height: 10px;
            background-color: #FF69B4;
            border-radius: 50%;
            position: absolute;
            top: -3px;
            right: -5px;
        }

        /* Bookmark button styles */
        .bookmark-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
            transition: all 0.3s;
        }
        
        .bookmark-btn svg {
            width: 24px;
            height: 24px;
            fill: transparent;
            stroke: #fff;
            stroke-width: 2;
            transition: all 0.3s;
        }
        
        .bookmark-btn.active svg {
            fill: #FFD700;
            stroke: #FFD700;
        }

        /* Filter tabs */
        .filter-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .filter-tab {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 14px;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .filter-tab.active {
            background-color: #FF69B4;
            color: white;
        }

        /* List view styles */
        .list-container {
            display: none;
            flex-direction: column;
            gap: 16px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .list-item {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .list-item:hover {
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        
        .list-question {
            background: linear-gradient(135deg, #FF69B4, #FFB6C1);
            color: white;
            padding: 12px 16px;
            font-weight: 500;
            position: relative;
        }
        
        .list-answer {
            padding: 12px 16px;
            border-top: 1px solid #f0f0f0;
            /* Ensure long texts break properly */
            overflow-wrap: break-word;
            word-wrap: break-word;
        }
        
        .list-actions {
            display: flex;
            justify-content: flex-end;
            padding: 8px 16px;
            min-height: 16px;
            gap: 8px;
            background-color: #f9f9f9;
        }
        
        .list-bookmark-btn {
            position: absolute;
            top: 8px;
            right: 8px;
        }
        
        .list-bookmark-btn svg {
            width: 18px;
            height: 18px;
            fill: transparent;
            stroke: #fff;
            stroke-width: 2;
        }
        
        .list-bookmark-btn.active svg {
            fill: #FFD700;
            stroke: #FFD700;
        }

        /* Pet container */
        .pet-container {
            width: 120px;
            height: 120px;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            transition: all 0.3s;
        }
        
        .pet-container:hover {
            transform: scale(1.2);
        }

        /* Mobile-specific styles */
        @media (max-width: 640px) {
            .mobile-nav-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                grid-gap: 8px;
            }
            
            .mobile-nav-grid button {
                width: 100%;
            }
            
            .pet-container {
                width: 80px;
                height: 80px;
                bottom: 10px;
                right: 10px;
            }
        }
    </style>
</head>
<body class="bg-light">
    <!-- Main container -->
    <div class="container mx-auto px-4 py-6 max-w-4xl">
        <!-- Header -->
        <header class="mb-4 text-center animate__animated animate__fadeIn">
            <h1 class="text-4xl font-bold text-primary mb-1">DUS Hazırlık Kartları - Bebecin Edition</h1>
            <p class="text-gray-600 italic">Seni seviyorum, başaracağına inanıyorum ♥</p>
        </header>
        
        <!-- Filter Tabs -->
        <div class="filter-container bg-white rounded-lg shadow-md p-3 mb-4 animate__animated animate__fadeIn">
            <div class="filter-tabs">
                <div id="filter-all" class="filter-tab active">Tümü</div>
                <div id="filter-bookmarked" class="filter-tab">Yer İmleri</div>
                <div id="filter-known" class="filter-tab">Bilinenler</div>
                <div id="filter-review" class="filter-tab">Tekrar Edilecekler</div>
            </div>
        </div>
        
        <!-- Statistics Display -->
        <div class="stats-container mb-4 bg-white rounded-lg shadow-md p-3 animate__animated animate__fadeIn animate__delay-1s">
            <div class="flex flex-wrap justify-around">
                <div class="stat-item text-center p-2">
                    <p class="text-sm text-gray-500">İlerleme</p>
                    <div class="progress-container relative h-4 bg-gray-200 rounded-full mt-1 w-60">
                        <div id="progress-bar" class="absolute top-0 left-0 h-full bg-primary rounded-full min-w-[4px]" style="width: 0%">
                            <div id="progress-dot" class="progress-dot hidden"></div>
                        </div>
                    </div>
                    <p id="progress-text" class="text-sm mt-1">0/0 soru</p>
                </div>
                
                <div class="stat-item text-center p-2">
                    <p class="text-sm text-gray-500">Doğru Bilinen</p>
                    <p id="known-count" class="text-xl font-bold text-green-500">0</p>
                </div>
                
                <div class="stat-item text-center p-2">
                    <p class="text-sm text-gray-500">Tekrar Et</p>
                    <p id="review-count" class="text-xl font-bold text-red-500">0</p>
                </div>
                
                <div class="stat-item text-center p-2">
                    <p class="text-sm text-gray-500">Yer İmleri</p>
                    <p id="bookmark-count" class="text-xl font-bold text-yellow-500">0</p>
                </div>
            </div>
        </div>
        
        <!-- Navigation Controls (only visible in card view) -->
        <div id="card-controls" class="controls mb-4 bg-white rounded-lg shadow-md p-3 animate__animated animate__fadeIn animate__delay-1s">
            <div class="hidden sm:flex sm:flex-wrap sm:justify-between sm:items-center">
                <div class="buttons-left flex space-x-2">
                    <button id="prev-btn" class="px-4 py-2 bg-secondary text-white rounded-lg hover:bg-primary transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span>← Önceki</span>
                    </button>
                    <button id="next-btn" class="px-4 py-2 bg-secondary text-white rounded-lg hover:bg-primary transition duration-300">
                        <span>Sonraki →</span>
                    </button>
                </div>
                
                <div class="buttons-right flex space-x-2">
                    <button id="shuffle-btn" class="px-4 py-2 bg-accent text-white rounded-lg hover:bg-pink-400 transition duration-300">
                        <span>Karıştır</span>
                    </button>
                    <button id="reset-btn" class="px-4 py-2 bg-red-400 text-white rounded-lg hover:bg-red-500 transition duration-300">
                        <span>Sıfırla</span>
                    </button>
                </div>
            </div>
            
            <!-- Mobile-specific navigation layout -->
            <div class="mobile-nav-grid sm:hidden">
                <button id="prev-btn-mobile" class="px-4 py-3 bg-secondary text-white rounded-lg hover:bg-primary transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span>← Önceki</span>
                </button>
                <button id="next-btn-mobile" class="px-4 py-3 bg-secondary text-white rounded-lg hover:bg-primary transition duration-300">
                    <span>Sonraki →</span>
                </button>
                <button id="shuffle-btn-mobile" class="px-4 py-3 bg-accent text-white rounded-lg hover:bg-pink-400 transition duration-300 mt-2">
                    <span>Karıştır</span>
                </button>
                <button id="reset-btn-mobile" class="px-4 py-3 bg-red-400 text-white rounded-lg hover:bg-red-500 transition duration-300 mt-2">
                    <span>Sıfırla</span>
                </button>
            </div>
        </div>
        
        <!-- Card Container (visible only in card view) -->
        <div id="card-container" class="card-container mb-4 h-80 animate__animated animate__zoomIn relative">
            <div id="card" class="card w-full h-full shadow-xl">
                <button id="bookmark-btn" class="bookmark-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                    </svg>
                </button>
                <div class="card-inner h-full">
                    <div class="card-front flex flex-col justify-center items-center">
                        <h2 class="text-2xl font-bold mb-4">Soru</h2>
                        <p id="question-text" class="text-xl text-center leading-relaxed px-4">Soruları yükleniyor...</p>
                    </div>
                    <div class="card-back flex flex-col justify-center items-center">
                        <h2 class="text-2xl font-bold mb-4 text-primary">Cevap</h2>
                        <p id="answer-text" class="text-xl text-center leading-relaxed px-4">Cevap yükleniyor...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- List View Container (visible only in filtered views) -->
        <div id="list-container" class="list-container mb-4">
            <!-- List items will be generated dynamically -->
        </div>

        <!-- Rating and Flip Container (visible only in card view) -->
        <div id="card-actions" class="action-container bg-white rounded-lg shadow-md p-4 mb-4 animate__animated animate__fadeIn animate__delay-2s">
            <div class="flex flex-col md:flex-row justify-center items-center space-y-4 md:space-y-0 md:space-x-4">
                <button id="flip-btn" class="w-full md:w-auto px-5 py-3 bg-primary text-white rounded-lg hover:bg-pink-600 transition duration-300 text-lg font-medium">
                    <span>Cevabı Göster</span>
                </button>
                
                <div class="flex justify-center space-x-4 w-full md:w-auto">
                    <button id="known-btn" class="w-full px-5 py-3 bg-green-400 text-white rounded-lg hover:bg-green-500 transition duration-300 text-lg font-medium">
                        <span>Biliyorum</span>
                    </button>
                    <button id="review-btn" class="w-full px-5 py-3 bg-red-400 text-white rounded-lg hover:bg-red-500 transition duration-300 text-lg font-medium">
                        <span>Tekrar Et</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- List View Actions Container (visible only in filtered views) -->
        <div id="list-actions-container" class="list-actions-container bg-white rounded-lg shadow-md p-4 mb-4 hidden">
            <div class="flex justify-center">
                <button id="reset-filter-btn" class="px-5 py-3 bg-secondary text-white rounded-lg hover:bg-primary transition duration-300 text-lg font-medium">
                    <span>Kart Görünümüne Dön</span>
                </button>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="text-center text-gray-500 text-sm mt-4 animate__animated animate__fadeIn animate__delay-2s">
            <p>Günmaru, 2025 ♥</p>
        </footer>
    </div>
    
    <!-- Notification container -->
    <div id="notification" class="notification bg-white shadow-lg rounded-lg p-4 border-l-4 border-primary">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <div class="ml-3">
                <p id="notification-text" class="text-sm text-gray-700"></p>
            </div>
        </div>
    </div>
    
    <!-- Pet container -->
    <div id="pet-container" class="pet-container animate__animated animate__bounceIn animate__delay-3s"></div>

    <!-- Loading overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-80 flex justify-center items-center z-50">
        <div class="text-center">
            <div class="heart-loader mb-4"></div>
            <p class="text-primary font-medium">Sınav hazırlık kartları yükleniyor...</p>
        </div>
    </div>

    <!-- Import virtual pet script -->
    <script src="virtual-pet.js"></script>
    
    <script>
        // Load questions from external file or fallback to embedded questions
        let questionsData = [];
        
        // Function to load questions from JSON file
        async function loadQuestions() {
            try {
                const response = await fetch('sorular.json');
                if (response.ok) {
                    questionsData = await response.json();
                    console.log(`Loaded ${questionsData.length} questions from JSON file`);
                } else {
                    console.error('Failed to load questions from JSON file, using fallback questions');
                    initWithFallbackQuestions();
                }
            } catch (error) {
                console.error('Error loading questions:', error);
                initWithFallbackQuestions();
            } finally {
                initApp();
            }
        }
        
        // Fallback questions if JSON file is not available
        function initWithFallbackQuestions() {
            questionsData = [
                { id: "q001", question: "Gram boyamada mordan nedir?", answer: "Boyayı hücreye bağlayan maddedir. İodine (İyot) kullanılır." },
                { id: "q002", question: "Kist ile abse arasındaki farklar nelerdir?", answer: "Kist: Oluşum yavaştır, epitel doku ile çevrilidir, sıvı berrak ve visközdür, normal doku basınç etkisiyle ezilir. Abse: İnflamasyonla hızlı oluşur, piyojenik membranla çevrilidir, içi püy doludur, normal doku lizis ile yıkılır." },
                { id: "q003", question: "Mycobacterium tuberculosis'in virülans faktörleri nelerdir?", answer: "Cord faktör (Trehaloz dimikolat), Sülfatidler (Sulfatides)" }
            ];
        }

        // Personal messages that will appear randomly
        const personalMessages = [
            "Seni çok seviyorum bebeimmm! ♥",
            "Harika bir diş hekimi olacaksın!",
            "Yanındayım askmmm!",
            "Akıllı bıdık <3",
            "Yakında kavuşacağız aşkım <333",
            "Biraz mola verip dinlenmeyi unutma bitanem!!!!"
        ];

        // App state
        let state = {
            currentIndex: 0,
            knownQuestions: {},
            reviewQuestions: {},
            bookmarkedQuestions: {},
            questionsOrder: [],
            originalQuestionsOrder: [],
            isCardFlipped: false,
            activeFilter: 'all',
            viewMode: 'card'
        };

        // DOM Elements
        const card = document.getElementById('card');
        const questionText = document.getElementById('question-text');
        const answerText = document.getElementById('answer-text');
        const progressBar = document.getElementById('progress-bar');
        const progressDot = document.getElementById('progress-dot');
        const progressText = document.getElementById('progress-text');
        const knownCount = document.getElementById('known-count');
        const reviewCount = document.getElementById('review-count');
        const bookmarkCount = document.getElementById('bookmark-count');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const prevBtnMobile = document.getElementById('prev-btn-mobile');
        const nextBtnMobile = document.getElementById('next-btn-mobile');
        const flipBtn = document.getElementById('flip-btn');
        const shuffleBtn = document.getElementById('shuffle-btn');
        const shuffleBtnMobile = document.getElementById('shuffle-btn-mobile');
        const resetBtn = document.getElementById('reset-btn');
        const resetBtnMobile = document.getElementById('reset-btn-mobile');
        const knownBtn = document.getElementById('known-btn');
        const reviewBtn = document.getElementById('review-btn');
        const bookmarkBtn = document.getElementById('bookmark-btn');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notification-text');
        const loadingOverlay = document.getElementById('loading-overlay');
        const petContainer = document.getElementById('pet-container');
        
        // View container elements
        const cardContainer = document.getElementById('card-container');
        const cardControls = document.getElementById('card-controls');
        const cardActions = document.getElementById('card-actions');
        const listContainer = document.getElementById('list-container');
        const listActionsContainer = document.getElementById('list-actions-container');
        const resetFilterBtn = document.getElementById('reset-filter-btn');
        
        // Filter tabs
        const filterAll = document.getElementById('filter-all');
        const filterBookmarked = document.getElementById('filter-bookmarked');
        const filterKnown = document.getElementById('filter-known');
        const filterReview = document.getElementById('filter-review');

        // Helper function to get question ID consistently
        function getQuestionId(questionIndex) {
            if (questionIndex < 0 || questionIndex >= questionsData.length) {
                return null;
            }
            const question = questionsData[questionIndex];
            return question.id || questionIndex.toString();
        }

        // Initialize the app
        function initApp() {
            loadState();
            
            // Initialize the original questions order
            if (state.originalQuestionsOrder.length === 0 || state.originalQuestionsOrder.length !== questionsData.length) {
                state.originalQuestionsOrder = Array.from({ length: questionsData.length }, (_, i) => i);
            }
            
            if (state.questionsOrder.length === 0 || state.questionsOrder.length !== questionsData.length) {
                state.questionsOrder = [...state.originalQuestionsOrder];
            }

            validateCurrentIndex();
            applyFilter(state.activeFilter);
            updateUI();
            
            if (window.VirtualPet) {
                const knownTotal = Object.keys(state.knownQuestions).length;
                const progress = questionsData.length > 0 ? (knownTotal / questionsData.length) * 100 : 0;
                window.VirtualPet.init(petContainer, progress);
            }
            
            setTimeout(() => {
                loadingOverlay.classList.add('animate__animated', 'animate__fadeOut');
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                }, 500);
            }, 1500);
            
            setTimeout(showRandomMessage, 10000);
        }

        function validateCurrentIndex() {
            if (questionsData.length === 0) {
                state.currentIndex = 0;
                return;
            }
            if (state.currentIndex < 0) {
                state.currentIndex = 0;
            } else if (state.currentIndex >= state.questionsOrder.length) {
                state.currentIndex = Math.max(0, state.questionsOrder.length - 1);
            }
        }

        function loadState() {
            try {
                const savedState = localStorage.getItem('medicalQuizState');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    state = { ...state, ...parsedState };
                }
            } catch (e) {
                console.error('Failed to parse saved state:', e);
                state = {
                    currentIndex: 0,
                    knownQuestions: {},
                    reviewQuestions: {},
                    bookmarkedQuestions: {},
                    questionsOrder: [],
                    originalQuestionsOrder: [],
                    isCardFlipped: false,
                    activeFilter: 'all',
                    viewMode: 'card'
                };
            }
        }

        function saveState() {
            try {
                localStorage.setItem('medicalQuizState', JSON.stringify({
                    currentIndex: state.currentIndex,
                    knownQuestions: state.knownQuestions,
                    reviewQuestions: state.reviewQuestions,
                    bookmarkedQuestions: state.bookmarkedQuestions,
                    questionsOrder: state.questionsOrder,
                    originalQuestionsOrder: state.originalQuestionsOrder,
                    activeFilter: state.activeFilter,
                    viewMode: state.viewMode
                }));
            } catch (e) {
                console.error('Failed to save state:', e);
                showNotification("Hata: İlerleme kaydedilemedi.", 3000);
            }
        }

        function applyFilter(filter) {
            state.activeFilter = filter;
            
            filterAll.classList.toggle('active', filter === 'all');
            filterBookmarked.classList.toggle('active', filter === 'bookmarked');
            filterKnown.classList.toggle('active', filter === 'known');
            filterReview.classList.toggle('active', filter === 'review');
            
            if (filter === 'all') {
                state.viewMode = 'card';
                state.questionsOrder = [...state.originalQuestionsOrder];
            } else {
                state.viewMode = 'list';
                let filteredOrder = [];
                
                switch (filter) {
                    case 'bookmarked':
                        for (let i = 0; i < questionsData.length; i++) {
                            const questionId = getQuestionId(i);
                            if (questionId && state.bookmarkedQuestions[questionId]) {
                                filteredOrder.push(i);
                            }
                        }
                        break;
                    case 'known':
                        for (let i = 0; i < questionsData.length; i++) {
                            const questionId = getQuestionId(i);
                            if (questionId && state.knownQuestions[questionId]) {
                                filteredOrder.push(i);
                            }
                        }
                        break;
                    case 'review':
                        for (let i = 0; i < questionsData.length; i++) {
                            const questionId = getQuestionId(i);
                            if (questionId && state.reviewQuestions[questionId]) {
                                filteredOrder.push(i);
                            }
                        }
                        break;
                }
                
                if (filteredOrder.length === 0) {
                    showNotification(`Bu filtre için hiç soru bulunamadı.`, 3000);
                }
                
                state.questionsOrder = filteredOrder;
            }
            
            state.currentIndex = 0;
            saveState();
            updateUI();
        }

        function updateUI() {
            if (questionsData.length === 0) {
                questionText.textContent = "Henüz soru eklenmemiş.";
                answerText.textContent = "Lütfen soru ekleyin.";
                disableControls(true);
                return;
            }
            
            validateCurrentIndex();
            
            cardContainer.style.display = state.viewMode === 'card' ? 'block' : 'none';
            cardControls.style.display = state.viewMode === 'card' ? 'block' : 'none';
            cardActions.style.display = state.viewMode === 'card' ? 'block' : 'none';
            
            listContainer.style.display = state.viewMode === 'list' ? 'flex' : 'none';
            listActionsContainer.style.display = state.viewMode === 'list' ? 'block' : 'none';
            
            if (state.viewMode === 'card' && state.questionsOrder.length > 0) {
                const currentQuestionIndex = state.questionsOrder[state.currentIndex];
                if (currentQuestionIndex === undefined || !questionsData[currentQuestionIndex]) {
                    console.error("Invalid question index:", currentQuestionIndex);
                    state.currentIndex = 0;
                    updateUI();
                    return;
                }
                const currentQuestion = questionsData[currentQuestionIndex];
                questionText.textContent = currentQuestion.question || "Soru bulunamadı";
                answerText.textContent = currentQuestion.answer || "Cevap bulunamadı";
                
                if (state.isCardFlipped) {
                    card.classList.remove('flipped');
                    state.isCardFlipped = false;
                    flipBtn.textContent = "Cevabı Göster";
                }
                
                const isFirstQuestion = state.currentIndex === 0;
                const isLastQuestion = state.currentIndex === state.questionsOrder.length - 1;
                
                prevBtn.disabled = isFirstQuestion;
                prevBtnMobile.disabled = isFirstQuestion;
                nextBtn.disabled = isLastQuestion;
                nextBtnMobile.disabled = isLastQuestion;
                
                const currentId = getQuestionId(currentQuestionIndex);
                knownBtn.classList.remove('ring-4', 'ring-green-200');
                reviewBtn.classList.remove('ring-4', 'ring-red-200');
                bookmarkBtn.classList.remove('active');
                
                if (currentId) {
                    if (state.knownQuestions[currentId]) {
                        knownBtn.classList.add('ring-4', 'ring-green-200');
                    }
                    if (state.reviewQuestions[currentId]) {
                        reviewBtn.classList.add('ring-4', 'ring-red-200');
                    }
                    if (state.bookmarkedQuestions[currentId]) {
                        bookmarkBtn.classList.add('active');
                    }
                }
            }
            else if (state.viewMode === 'list') {
                renderListView();
            }
            
            const knownTotal = Object.keys(state.knownQuestions).length;
            const reviewTotal = Object.keys(state.reviewQuestions).length;
            const bookmarkTotal = Object.keys(state.bookmarkedQuestions).length;
            const progress = questionsData.length > 0 ? Math.round((knownTotal / questionsData.length) * 100) : 0;
            
            if (knownTotal > 0 && progress < 2) {
                progressBar.style.width = '4px';
                progressDot.classList.remove('hidden');
            } else {
                progressBar.style.width = `${progress}%`;
                progressDot.classList.add('hidden');
            }
            
            if (state.viewMode === 'card') {
                progressText.textContent = `${state.currentIndex + 1}/${state.questionsOrder.length} soru`;
            } else {
                progressText.textContent = `${state.questionsOrder.length} soru`;
            }
            
            knownCount.textContent = knownTotal;
            reviewCount.textContent = reviewTotal;
            bookmarkCount.textContent = bookmarkTotal;
            
            if (window.VirtualPet) {
                window.VirtualPet.updateProgress(progress);
            }
            
            try {
                saveState();
            } catch (e) {
                console.error('Failed to save state:', e);
            }
        }

        function renderListView() {
            listContainer.innerHTML = '';
            
            if (state.questionsOrder.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'text-center p-4 text-gray-500';
                emptyMessage.textContent = 'Bu kategoride hiç soru bulunamadı.';
                listContainer.appendChild(emptyMessage);
                return;
            }
            
            state.questionsOrder.forEach((questionIndex, index) => {
                const question = questionsData[questionIndex];
                if (!question) return;
                
                const questionId = getQuestionId(questionIndex);
                const listItem = document.createElement('div');
                listItem.className = 'list-item';
                listItem.dataset.index = index;
                
                const questionElement = document.createElement('div');
                questionElement.className = 'list-question';
                questionElement.textContent = question.question;
                
                const bookmarkElement = document.createElement('button');
                bookmarkElement.className = `list-bookmark-btn ${state.bookmarkedQuestions[questionId] ? 'active' : ''}`;
                bookmarkElement.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                    </svg>
                `;
                bookmarkElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleBookmarkInList(questionId, bookmarkElement);
                });
                questionElement.appendChild(bookmarkElement);
                
                const answerElement = document.createElement('div');
                answerElement.className = 'list-answer';
                answerElement.textContent = question.answer;
                
                const actionsElement = document.createElement('div');
                actionsElement.className = 'list-actions';
                
                const knownBtnElement = document.createElement('button');
                knownBtnElement.className = `px-3 py-1 bg-green-400 text-white rounded-lg hover:bg-green-500 transition duration-300 text-sm ${state.knownQuestions[questionId] ? 'ring-2 ring-green-200' : ''}`;
                knownBtnElement.textContent = 'Biliyorum';
                knownBtnElement.addEventListener('click', () => toggleKnownInList(questionId, knownBtnElement, reviewBtnElement));
                
                const reviewBtnElement = document.createElement('button');
                reviewBtnElement.className = `px-3 py-1 bg-red-400 text-white rounded-lg hover:bg-red-500 transition duration-300 text-sm ${state.reviewQuestions[questionId] ? 'ring-2 ring-red-200' : ''}`;
                reviewBtnElement.textContent = 'Tekrar Et';
                reviewBtnElement.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleReviewInList(questionId, knownBtnElement, reviewBtnElement);
});
                
                actionsElement.appendChild(knownBtnElement);
                actionsElement.appendChild(reviewBtnElement);
                
                listItem.appendChild(questionElement);
                listItem.appendChild(answerElement);
                listItem.appendChild(actionsElement);
                
                listContainer.appendChild(listItem);
            });
        }

        // Updated toggle functions for list view to immediately reapply the active filter
        function toggleBookmarkInList(questionId, buttonElement) {
            if (state.bookmarkedQuestions[questionId]) {
                delete state.bookmarkedQuestions[questionId];
                buttonElement.classList.remove('active');
                showNotification("Soru yer imlerinden kaldırıldı.");
            } else {
                state.bookmarkedQuestions[questionId] = true;
                buttonElement.classList.add('active');
                showNotification("Soru yer imlerine eklendi.");
                createConfetti(5);
            }
            if (state.activeFilter === 'bookmarked') {
                applyFilter('bookmarked');
            } else {
                updateUI();
            }
        }

        function toggleKnownInList(questionId, knownBtn, reviewBtn) {
            if (state.reviewQuestions[questionId]) {
                delete state.reviewQuestions[questionId];
                reviewBtn.classList.remove('ring-2', 'ring-red-200');
            }
            
            if (state.knownQuestions[questionId]) {
                delete state.knownQuestions[questionId];
                knownBtn.classList.remove('ring-2', 'ring-green-200');
                showNotification("Soru bilinmiyor olarak işaretlendi.");
            } else {
                state.knownQuestions[questionId] = true;
                knownBtn.classList.add('ring-2', 'ring-green-200');
                showNotification("Soru biliniyor olarak işaretlendi! 🎉");
                createConfetti(10);
                const knownTotal = Object.keys(state.knownQuestions).length;
                if (knownTotal % 10 === 0) {
                    setTimeout(() => {
                        showNotification(`Tebrikler! ${knownTotal} soruyu biliyorsun! 🥳`, 3000);
                        createConfetti(30);
                        if (window.VirtualPet) {
                            window.VirtualPet.celebrate();
                        }
                    }, 1000);
                }
            }
            
            if (state.activeFilter === 'known') {
                applyFilter('known');
            } else {
                updateUI();
            }
        }

        function toggleReviewInList(questionId, knownBtn, reviewBtn) {
            if (state.knownQuestions[questionId]) {
                delete state.knownQuestions[questionId];
                knownBtn.classList.remove('ring-2', 'ring-green-200');
            }
            
            if (state.reviewQuestions[questionId]) {
                delete state.reviewQuestions[questionId];
                reviewBtn.classList.remove('ring-2', 'ring-red-200');
                showNotification("Soru tekrar listesinden çıkarıldı.");
            } else {
                state.reviewQuestions[questionId] = true;
                reviewBtn.classList.add('ring-2', 'ring-red-200');
                showNotification("Soru tekrar edilecek olarak işaretlendi.");
            }
            
            if (state.activeFilter === 'review') {
                applyFilter('review');
            } else {
                updateUI();
            }
        }

        // Toggle bookmark for current card view question
        function toggleBookmark() {
            const currentQuestionIndex = state.questionsOrder[state.currentIndex];
            if (currentQuestionIndex === undefined || currentQuestionIndex < 0 || currentQuestionIndex >= questionsData.length) {
                console.error("Invalid question index for bookmarking");
                return;
            }
            
            const currentId = getQuestionId(currentQuestionIndex);
            if (!currentId) {
                console.error("Cannot get valid ID for current question");
                return;
            }
            
            if (state.bookmarkedQuestions[currentId]) {
                delete state.bookmarkedQuestions[currentId];
                showNotification("Soru yer imlerinden kaldırıldı.");
                bookmarkBtn.classList.remove('active');
            } else {
                state.bookmarkedQuestions[currentId] = true;
                showNotification("Soru yer imlerine eklendi.");
                bookmarkBtn.classList.add('active');
                createConfetti(5);
            }
            
            updateUI();
        }

        function flipCard() {
            card.classList.toggle('flipped');
            state.isCardFlipped = !state.isCardFlipped;
            flipBtn.textContent = state.isCardFlipped ? "Soruyu Göster" : "Cevabı Göster";
        }

        function nextQuestion() {
            if (state.currentIndex < state.questionsOrder.length - 1) {
                state.currentIndex++;
                updateUI();
            }
        }

        function previousQuestion() {
            if (state.currentIndex > 0) {
                state.currentIndex--;
                updateUI();
            }
        }

        function markAsKnown() {
            const currentQuestionIndex = state.questionsOrder[state.currentIndex];
            if (currentQuestionIndex === undefined || currentQuestionIndex < 0 || currentQuestionIndex >= questionsData.length) {
                console.error("Invalid question index for marking as known");
                return;
            }
            
            const currentId = getQuestionId(currentQuestionIndex);
            if (!currentId) {
                console.error("Cannot get valid ID for current question");
                return;
            }
            
            if (state.reviewQuestions[currentId]) {
                delete state.reviewQuestions[currentId];
            }
            
            if (state.knownQuestions[currentId]) {
                delete state.knownQuestions[currentId];
                showNotification("Soru bilinmiyor olarak işaretlendi.");
            } else {
                state.knownQuestions[currentId] = true;
                showNotification("Soru biliniyor olarak işaretlendi! 🎉");
                createConfetti(10);
                const knownTotal = Object.keys(state.knownQuestions).length;
                if (knownTotal % 10 === 0) {
                    setTimeout(() => {
                        showNotification(`Tebrikler! ${knownTotal} soruyu biliyorsun! 🥳`, 3000);
                        createConfetti(30);
                        if (window.VirtualPet) {
                            window.VirtualPet.celebrate();
                        }
                    }, 1000);
                }
            }
            
            updateUI();
            
            if (state.currentIndex < state.questionsOrder.length - 1) {
                setTimeout(nextQuestion, 800);
            }
        }

        function markForReview() {
            const currentQuestionIndex = state.questionsOrder[state.currentIndex];
            if (currentQuestionIndex === undefined || currentQuestionIndex < 0 || currentQuestionIndex >= questionsData.length) {
                console.error("Invalid question index for marking for review");
                return;
            }
            
            const currentId = getQuestionId(currentQuestionIndex);
            if (!currentId) {
                console.error("Cannot get valid ID for current question");
                return;
            }
            
            if (state.knownQuestions[currentId]) {
                delete state.knownQuestions[currentId];
            }
            
            if (state.reviewQuestions[currentId]) {
                delete state.reviewQuestions[currentId];
                showNotification("Soru tekrar listesinden çıkarıldı.");
            } else {
                state.reviewQuestions[currentId] = true;
                showNotification("Soru tekrar edilecek olarak işaretlendi.");
            }
            
            updateUI();
            
            if (state.currentIndex < state.questionsOrder.length - 1) {
                setTimeout(nextQuestion, 800);
            }
        }

        function shuffleQuestions() {
            if (state.questionsOrder.length <= 1) {
                showNotification("Karıştırmak için en az 2 soru gerekiyor.");
                return;
            }
            
            state.questionsOrder = shuffleArray([...state.questionsOrder]);
            state.currentIndex = 0;
            showNotification("Sorular karıştırıldı!");
            updateUI();
        }

        function resetProgress() {
            if (confirm("Tüm ilerlemeniz sıfırlanacak. Emin misiniz?")) {
                state.knownQuestions = {};
                state.reviewQuestions = {};
                state.bookmarkedQuestions = {};
                state.currentIndex = 0;
                state.activeFilter = 'all';
                state.viewMode = 'card';
                
                state.originalQuestionsOrder = Array.from({ length: questionsData.length }, (_, i) => i);
                state.questionsOrder = [...state.originalQuestionsOrder];
                
                filterAll.classList.add('active');
                filterBookmarked.classList.remove('active');
                filterKnown.classList.remove('active');
                filterReview.classList.remove('active');
                
                showNotification("İlerleme sıfırlandı.");
                
                if (window.VirtualPet) {
                    window.VirtualPet.reset();
                }
                
                updateUI();
            }
        }

        function resetFilter() {
            applyFilter('all');
        }

        function showNotification(message, duration = 2000) {
            if (!message) return;
            notificationText.textContent = message;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        function createConfetti(count = 20) {
            const colors = ['#FF69B4', '#FFB6C1', '#FFC0CB', '#FF1493', '#FFA07A'];
            for (let i = 0; i < count; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                confetti.style.opacity = Math.random() + 0.5;
                document.body.appendChild(confetti);
                setTimeout(() => {
                    confetti.remove();
                }, 5000);
            }
        }

        function showRandomMessage() {
            if (personalMessages.length > 0) {
                const message = personalMessages[Math.floor(Math.random() * personalMessages.length)];
                showNotification(message, 4000);
                const nextTime = Math.random() * 90000 + 30000;
                setTimeout(showRandomMessage, nextTime);
            }
        }

        function shuffleArray(array) {
            if (!Array.isArray(array) || array.length === 0) {
                return array;
            }
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function disableControls(disabled) {
            prevBtn.disabled = disabled;
            nextBtn.disabled = disabled;
            prevBtnMobile.disabled = disabled;
            nextBtnMobile.disabled = disabled;
            flipBtn.disabled = disabled;
            shuffleBtn.disabled = disabled;
            shuffleBtnMobile.disabled = disabled;
            resetBtn.disabled = disabled;
            resetBtnMobile.disabled = disabled;
            knownBtn.disabled = disabled;
            reviewBtn.disabled = disabled;
            bookmarkBtn.disabled = disabled;
            
            filterAll.style.pointerEvents = disabled ? 'none' : 'auto';
            filterBookmarked.style.pointerEvents = disabled ? 'none' : 'auto';
            filterKnown.style.pointerEvents = disabled ? 'none' : 'auto';
            filterReview.style.pointerEvents = disabled ? 'none' : 'auto';
        }

        // Event listeners
        flipBtn.addEventListener('click', flipCard);
        nextBtn.addEventListener('click', nextQuestion);
        prevBtn.addEventListener('click', previousQuestion);
        nextBtnMobile.addEventListener('click', nextQuestion);
        prevBtnMobile.addEventListener('click', previousQuestion);
        knownBtn.addEventListener('click', markAsKnown);
        reviewBtn.addEventListener('click', markForReview);
        bookmarkBtn.addEventListener('click', toggleBookmark);
        shuffleBtn.addEventListener('click', shuffleQuestions);
        shuffleBtnMobile.addEventListener('click', shuffleQuestions);
        resetBtn.addEventListener('click', resetProgress);
        resetBtnMobile.addEventListener('click', resetProgress);
        resetFilterBtn.addEventListener('click', resetFilter);
        
        filterAll.addEventListener('click', () => applyFilter('all'));
        filterBookmarked.addEventListener('click', () => applyFilter('bookmarked'));
        filterKnown.addEventListener('click', () => applyFilter('known'));
        filterReview.addEventListener('click', () => applyFilter('review'));

        document.addEventListener('keydown', (e) => {
            if (state.viewMode === 'card') {
                if (e.key === 'ArrowRight') nextQuestion();
                else if (e.key === 'ArrowLeft') previousQuestion();
                else if (e.key === ' ' || e.key === 'Enter') flipCard();
                else if (e.key === 'k') markAsKnown();
                else if (e.key === 'r') markForReview();
                else if (e.key === 'b') toggleBookmark();
            }
        });

        petContainer.addEventListener('click', () => {
            if (window.VirtualPet) {
                window.VirtualPet.interact();
            }
        });

        window.onerror = function(message, source, lineno, colno, error) {
            console.error("Error caught:", message, "at", source, ":", lineno, ":", colno);
            showNotification("Bir hata oluştu: " + message, 5000);
            return true;
        };

        loadQuestions();
    </script>
</body>
</html>
